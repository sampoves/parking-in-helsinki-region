<!DOCTYPE html>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<html>
    <head>
        <title>Parking private cars in Helsinki Capital Region</title>
        <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
        <script>L_PREFER_CANVAS=false; L_NO_TOUCH=false; L_DISABLE_3D=false;</script>
        
        <!-- import leaflet and leaflet.draw-->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.4.0/leaflet.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.EasyButton/2.4.0/easy-button.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-ajax/2.1.0/leaflet.ajax.js"></script>
        
        <!--import parking survey variables -->
        <script type="text/javascript" src="park_survey.js"></script>
        <script type="text/javascript" src="survey_info.js"></script>
        
        <!-- my css stylesheet -->
        <link rel="stylesheet" href="style.css">
        
        <!-- other stylesheets -->
        <link href="http://netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.4.0/leaflet.css"/>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.EasyButton/2.4.0/easy-button.css"/>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"/>
        
        <!-- font -->
        <link href="https://fonts.googleapis.com/css?family=Montserrat" rel="stylesheet">
        
        <meta name="viewport" content="width=device-width,
            initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
        
    </head>
    <body>
        <div class="" id="mymap" ></div>
            
        <script>
    //Alkututorial??
    //SCRIPT omaan js-tiedostoon
    //Tuota cookie, joka muistaa overlaylisäykset, miten cookieen monta valuee? 
    //Sivulle kun tulee niin pitäisi käyttäjälle tulla jotain infoa että mitä pitäisi tehdä
    //Alkuinfon jälkeen pointterin lisääminen kartalle voisi olla defaulttina aktivoituna, jotta ensimmäisen pisteen saa nopeasti lisättyä
    //Kun pisteen on lisännyt olisi hyvä jos kysely popup aukeaisi automaattisesti
    //infonappulaa kun painaa niin infoa ei saa mistään suljettua (muuta kuin päivittämällä koko sivun)
    //ALEMPI PRIORITEETTI Päivämäärää kysyessä kalenteri kannattaisi avata automaattisesti.
            
            //TEST COOKIE
            console.log(document.cookie + " ennen definitonii");
            console.log(document.cookie === "survey_tilelayer_choice=Stamen terrain" + " testin tulos");
            
            function create_cookie(name, value, days2expire, path) {
                var date = new Date();
                date.setTime(date.getTime() + (days2expire * 24 * 60 * 60 * 1000));
                var expires = date.toUTCString();
                document.cookie = name + '=' + value + ';' +
                                 'expires=' + expires + ';' +
                                 'path=' + path + ';';
              };
            
            

            // INITIALISE MAP AND LAYERS
            //bounds variables
            var corner1 = [60.45, 24.37];
            var corner2 = [60.05, 25.305884];
            var bounds = L.latLngBounds(corner1, corner2);
            
            //initialise map
            var mymap = L.map(
                'mymap', {
                center: [60.1743, 24.9356],
                zoom: 13,
                maxBounds: bounds,
                maxBoundsViscosity: 0.8,
                layers: [],
                worldCopyJump: false,
                crs: L.CRS.EPSG3857,
                zoomControl: true
            });
 
            //events to listen for baselayer or overlay change for to use of 
            //cookies
            //https://leafletjs.com/reference-1.4.0.html#map-baselayerchange
            mymap.on('baselayerchange', function(e) {
                console.log(e.name + " tallennettu cookieen");
                var cookie_name = "survey_tilelayer_choice";
                var cookie_value = e.name;
                create_cookie(cookie_name, cookie_value, 90, "/");
            });

            mymap.on("overlayadd", function(e){
                console.log(e);
            });
            mymap.on("overlayremove", function(e){
                console.log(e);
            });
 
            //initialise background tiles
            //CartoDB dark_matter
            var darkmatter = L.tileLayer(
                    'https://cartodb-basemaps-{s}.global.ssl.fastly.net/dark_all/{z}/{x}/{y}.png',
                {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                    "detectRetina": false,
                    "maxNativeZoom": 18,
                    "maxZoom": 18,
                    "minZoom": 0,
                    "noWrap": false,
                    "opacity": 1,
                    "subdomains": "abc",
                    "tms": false
            })//.addTo(mymap);

            //OpenStreetMap
            var OpenStreetMap_DE = L.tileLayer('https://{s}.tile.openstreetmap.de/tiles/osmde/{z}/{x}/{y}.png', {
                    minZoom: 0,
                    maxZoom: 18,
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            });

            //Stamen terrain
            var Stamen_Terrain = L.tileLayer('https://stamen-tiles-{s}.a.ssl.fastly.net/terrain/{z}/{x}/{y}{r}.{ext}', {
                    attribution: 'Map tiles by <a href="http://stamen.com">Stamen Design</a>, <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a> &mdash; Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                    subdomains: 'abcd',
                    minZoom: 0,
                    maxZoom: 18,
                    ext: 'png'
            });
            
            //attempt to addto mymap cookie value
            if(document.cookie === "survey_tilelayer_choice=CartoDB dark_matter"){
                darkmatter.addTo(mymap);
            } else if (document.cookie === "survey_tilelayer_choice=OpenStreetMap") {
                OpenStreetMap_DE.addTo(mymap);
            } else if (document.cookie === "survey_tilelayer_choice=Stamen terrain"){
                Stamen_Terrain.addTo(mymap);
            } else {
                darkmatter.addTo(mymap);
            }
            

            //MITEN SAADA POPUP AUKI HETI MARKERIN KIINNITÄMISEN JÄLKJEEN?
            // yks johtolanka: https://jsfiddle.net/emmalivingstone/abpee1ym/

            // import empty GeoJSON to be populated by user with responses
            var geojson = L.geoJson({
                "type": "FeatureCollection",
                "features": []
                },{
                    onEachFeature:
                            function (feature, layer){
                                layer.on('click', layerClickHandler);
                            }
                }).addTo(mymap);
            
            // BACKGROUND GEOJSON LAYERS
            //import postal codes areas GeoJSON from file
            var stylePostal = {
                "color": "#ff7800",
                "weight": 3,
                "opacity": 0.4,
                "fillOpacity": 0
            };        
    
            var styleArea = {
                "color": "#ff7800",
                "weight": 3,
                "opacity": 0.3,
                "fillColor": '#0000FF',
                "fillOpacity": 0
            };   
            
            var stylePien = {
                "color": "#f316f7",
                "weight": 3,
                "opacity": 0.3,
                "fillColor": '#0000FF',
                "fillOpacity": 0
            };   
    
            var postal = new L.GeoJSON.AJAX(
                    "pno_research_area.geojson", {
                        style: stylePostal
            }).addTo(mymap);
            
            var postaldissolve = new L.GeoJSON.AJAX(
                    "pno_dissolve.geojson", {
                        style: styleArea
                
            }).addTo(mymap);
            var pienalue = new L.GeoJSON.AJAX(
                    "seutukartta_pienalue.geojson", {
                        style: stylePien
            });//.addTo(mymap);


            //add layer control
            var baseMaps = {
                "OpenStreetMap": OpenStreetMap_DE,
                "CartoDB dark_matter": darkmatter,
                "Stamen terrain": Stamen_Terrain
            };

            var overlayMaps = {
                "Seutukartta pienalue": pienalue,
                "Postal areas": postal,
                "Research area": postaldissolve
            };
            L.control.layers(baseMaps, overlayMaps).addTo(mymap);
           
           
           
           
            //Listen to changes in form
            //this listener idea from: http://embed.plnkr.co/8qVoW5/
            function layerClickHandler (e) {
                var marker = e.target,
                        properties = e.target.feature.properties;
                
                if(marker.hasOwnProperty('_popup')){
                    marker.unbindPopup();
                }
                
                //check if all values are inserted and print text in popUp
                //if this is the case
                if(!properties.datetime || !properties.likert 
                    || !properties.parkspot || !properties.parktime){
                    marker.bindPopup(popupContent + missingStuff);
                    marker._icon.src = 
                            'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png';
                } else {
                    marker.bindPopup(popupContent);
                    marker._icon.src = 
                            'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png';
                }
                marker.openPopup();

                //EVENT LISTENERS
                //DATETIME
                L.DomUtil.get('datetime').textContent = properties.datetime;
                var dateTime = L.DomUtil.get('datetime');
                dateTime.value = properties.datetime;
                L.DomEvent.addListener(dateTime, "change", function (e){
                    properties.datetime = e.target.value;
                });
                
                //PARKING TIME
                L.DomUtil.get('parktime').textContent = properties.parktime;
                var parkTime = L.DomUtil.get('parktime');
                parkTime.value = properties.parktime;
                L.DomEvent.addListener(parkTime, "change", function (e){
                    properties.parktime = e.target.value;
                });
                
                //LIKERT
                $(L.DomUtil.get('likert')).find(
                        "input[value='" + properties.likert+ "']").attr('checked', true);
                $(document).ready(function(){
                    $('input[name=likert]').click(function(){
                        properties.likert = this.value;
                    });
                });

                //PARKSPOT
                if(typeof currentParkspotValue !== 'undefined'){
                    $(L.DomUtil.get('parkspot')).find(
                            "option[value='" + currentParkspotValue + "']").attr('selected', true);
                    var parkSpot = L.DomUtil.get('parkspot');
                    parkSpot.value = properties.parkspot;
                    L.DomEvent.addListener(parkSpot, "change", function(e){
                        properties.parkspot = e.target.value;
                    });
                } else {
                    L.DomUtil.get('parkspot').value = properties.parkspot;
                    var parkSpot = L.DomUtil.get('parkspot');
                    parkSpot.value = properties.parkspot;
                    L.DomEvent.addListener(parkSpot, "change", function (e){
                        properties.parkspot = e.target.value;
                    });
                }

                //SAVE BUTTON
                var buttonSubmit = L.DomUtil.get('button-submit');
                L.DomEvent.addListener(buttonSubmit, "click", function (e){
                    marker.closePopup();
                });
            }
    

            // POSSIBLE TO FIND FEATURE DATA WITH INTERNAL LAYER ID
            //geojson.getLayer(113).feature.properties.parktime
            function onParkspotChange(event){
                currentParkspotValue = event.target.value;
                //console.log("parkspot value set to " + event.target.value);
            };
    
    
            // INFOTEXT AND INFOBUTTON
            // infotext and infobutton and associated stuff    
            var infoText = L.control({position: 'bottomleft'});
            
            infoText.onAdd = function (map) {
                this._div = L.DomUtil.create('div', 'infotext');
                this.update("");
                return this._div;
            };
            
            infoText.update = function(text){
                this._div.innerHTML = text;
            };
            
            infoText.addTo(mymap);

            var infoBox = L.control({position: 'bottomleft'});
            
            infoBox.onAdd = function (map) {
                this._div = L.DomUtil.create('div', 'infobox');
                this._div.innerHTML = basicInfo;
                return this._div;
            };
            
            var infoButton = L.easyButton({
                states: [{
                    stateName: 'infoOpen',
                    icon: 'fa fa-info',
                    title: 'Avaa info',
                    onClick: function (btn, map) {
                        infoBox.addTo(map);
                        btn.state('infoClose');
                    }
                }, {
                    stateName: 'infoClose',
                    icon: 'fa fa-info',
                    title: 'Sulje info',
                    onClick: function (btn, map) {
                        infoBox.remove(map);
                        btn.state('infoOpen');
                    }
                }]
            });
            infoButton.addTo(mymap);
            
            
            // INFOHEADER
            var infoHeader = L.control();
            infoHeader.onAdd = function (map) {
                this._div = L.DomUtil.create('div', 'infoheader');
                this.update();
                return this._div;
            };
            infoHeader.update = function () {
                this._div.innerHTML = infoHeaderStuff;
            };
            infoHeader.addTo(mymap);
            
            
            // TEE COOKIE JOTTA KÄYTTÄJÄ VOI VALITA KARTTATASON TMS
            // https://www.w3schools.com/js/js_cookies.asp
            //060219 MIKSI MARKER MUUTTUU VIELÄ LYHYESTI SINISEKSI EKAN KERRAN KLIKATESSA
            //MARKERIN KANSSA KARTTAA?
            
            //initialise drawing tools, disable a bunch
            var draw_control = new L.Control.Draw({
                "edit": {
                    "featureGroup": geojson
                },
                "draw": {
                    marker: {
                        icon: new L.Icon({
                            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
                            shadowUrl: 'http://cdn.leafletjs.com/leaflet-0.6.4/images/marker-shadow.png',
                            iconAnchor: [12, 40],
                            popupAnchor: [0, -41]
                        }),
                        shapeOptions: {
                            clickable: true
                        }
                        
                    },
                    polyline: false,
                    polygon: false,
                    rectangle: false,
                    circle: false,
                    circlemarker: false
                }
            }).addTo(mymap);
            

            mymap.on(L.Draw.Event.CREATED, function (e) {
                var layer = e.layer;
                var lat = layer.getLatLng().lat;
                var lng = layer.getLatLng().lng;
                var geojsonFeature = {
                        "type": "Feature",
                        "geometry": {
                            "type": "Point",
                            "coordinates": [lng, lat]
                        },
                        "properties":{
                            "datetime": null,
                            "parktime": null,
                            "likert": null,
                            "parkspot": null
                        }
                };
                layer.on('click', layerClickHandler); //"mouseover", "click"
                geojson.addData(geojsonFeature);
            });

            mymap.on('draw:created', function(e) {
                var layer = e.layer;
                var lat = layer.getLatLng().lat;
                var lng = layer.getLatLng().lng;
                var geojsonFeature = {
                        "type": "Feature",
                        "geometry": {
                            "type": "Point",
                            "coordinates": [lng, lat]
                        },
                        "properties":{
                            "parktime": null
                        }
                };
                
            });
            
//
//            // Object created - bind popup to layer, add to feature group
//            mymap.on(L.Draw.Event.CREATED, function(event) {
//                var layer = event.layer;
//                var content = strLatLng(layer.getLatLng());
//                if (content !== null) {
//                    layer.bindPopup(content);
//                }
//                drawnItems.addLayer(layer);
//            });
//
            // Object(s) edited - update popups
            mymap.on(L.Draw.Event.EDITED, function(event) {
                var layers = event.layers,
                    content = null;

                layers.eachLayer(function(layer) {
                    content = getPopupContent(layer);
                    if (content !== null) {
                        layer.setPopupContent(content);
                    }
                });
            });
        </script>
    </body>
</html>