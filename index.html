<!DOCTYPE html>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<html>
    <head>
        <title>Leaflet-megakysely</title>
        <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
        <script>L_PREFER_CANVAS=false; L_NO_TOUCH=false; L_DISABLE_3D=false;</script>
        
        <!-- import leaflet and leaflet.draw-->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.4.0/leaflet.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.EasyButton/2.4.0/easy-button.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
        
        <!--import parking survey variable -->
        <script type="text/javascript" src="park_survey.js"></script>
        
        <!-- my css stylesheet -->
        <link rel="stylesheet" href="style.css">
        
        <!-- other stylesheets -->
        <link href="http://netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.4.0/leaflet.css"/>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.EasyButton/2.4.0/easy-button.css"/>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"/>
        
        <!-- font -->
        <link href="https://fonts.googleapis.com/css?family=Montserrat" rel="stylesheet">
        
        <meta name="viewport" content="width=device-width,
            initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
        
    </head>
    <body>
        <div class="" id="mymap" ></div>
        
        <script>
            //bounds variables
            var corner1 = [60.371108, 24.598389];
            var corner2 = [60.086763, 25.405884];
            var bounds = L.latLngBounds(corner1, corner2);
            
            //initialise map
            var mymap = L.map(
                'mymap', {
                center: [60.1743, 24.9356],
                zoom: 13,
                maxBounds: bounds,
                maxBoundsViscosity: 0.8,
                layers: [],
                worldCopyJump: false,
                crs: L.CRS.EPSG3857,
                zoomControl: true
            });
            
            //initialise background tiles
            var tileLayer = L.tileLayer(
                    'https://cartodb-basemaps-{s}.global.ssl.fastly.net/dark_all/{z}/{x}/{y}.png',
                    {
                    "attribution": null,
                    "detectRetina": false,
                    "maxNativeZoom": 18,
                    "maxZoom": 18,
                    "minZoom": 0,
                    "noWrap": false,
                    "opacity": 1,
                    "subdomains": "abc",
                    "tms": false
            }).addTo(mymap);

            //try to initialise geojson layer
            var geojson = L.geoJson({
                "type": "FeatureCollection",
                "features": [{
                        "type": "Feature",
                        "geometry": {
                            "type": "Point",
                            "coordinates": [24.9,60.15]
                        },
                        "properties":{
                            "parktime": 3
                        }
                }]
            }, {
                onEachFeature: function (feature, layer){
                    layer.on('click', layerClickHandler);
                }
            }).addTo(mymap);
            
                        
            function layerClickHandler (e) {
                var marker = e.target,
                        properties = e.target.feature.properties;
                
                if(marker.hasOwnProperty('_popup')){
                    marker.unbindPopup();
                }
                marker.bindPopup(popupContent);
                marker.openPopup();
                
                L.DomUtil.get('parktime').textContent = properties.parktime;
                
                var parkTime = L.DomUtil.get('parktime');
                parkTime.value = properties.parktime;
                L.DomEvent.addListener(parkTime, "change", function (e){
                    properties.parktime = e.target.value;
                });
                
                var buttonSubmit = L.DomUtil.get('button-submit');
                L.DomEvent.addListener(buttonSubmit, "click", function (e){
                    marker.closePopup();
                });
            }
    
            // infotext and infobutton and associated stuff    
            var infoText = L.control({position: 'bottomleft'});
            
            infoText.onAdd = function (map) {
                this._div = L.DomUtil.create('div', 'infotext');
                this.update("");
                return this._div;
            };
            
            infoText.update = function(text){
                this._div.innerHTML = text;
            };
            
            infoText.addTo(mymap);

            var infoBox = L.control({position: 'bottomleft'});
            
            infoBox.onAdd = function (map) {
                this._div = L.DomUtil.create('div', 'infobox');
                this._div.innerHTML = 'Did you ever hear the tragedy of Darth Plagueis The Wise? I thought not. It\'s not a story the Jedi would tell you. It\'s a Sith legend. Darth Plagueis was a Dark Lord of the Sith, so powerful and so wise he could use the Force to influence the midichlorians to create life… He had such a knowledge of the dark side that he could even keep the ones he cared about from dying. The dark side of the Force is a pathway to many abilities some consider to be unnatural. He became so powerful… the only thing he was afraid of was losing his power, which eventually, of course, he did. Unfortunately, he taught his apprentice everything he knew, then his apprentice killed him in his sleep. Ironic. He could save others from death, but not himself.';
                return this._div;
            };
            
            var infoButton = L.easyButton({
                states: [{
                    stateName: 'infoOpen',
                    icon: 'fa fa-info',
                    title: 'Avaa info',
                    onClick: function (btn, map) {
                        infoBox.addTo(map);
                        btn.state('infoClose');
                    }
                }, {
                    stateName: 'infoClose',
                    icon: 'fa fa-info',
                    title: 'Sulje info',
                    onClick: function (btn, map) {
                        infoBox.remove(map);
                        btn.state('infoOpen');
                    }
                }]
            });
            infoButton.addTo(mymap);
            
            // FeatureGroup is to store editable layers.
            var drawnItems = new L.featureGroup().addTo(mymap);
            
            //initialise drawing tools, disable a bunch
            var draw_control = new L.Control.Draw({
                "edit": {
                    "featureGroup": drawnItems
                },
                "draw": {
                    marker: {
                        icon: new L.Icon({
                            iconUrl: 'http://cdn.leafletjs.com/leaflet-0.6.4/images/marker-icon.png',
                            shadowUrl: 'http://cdn.leafletjs.com/leaflet-0.6.4/images/marker-shadow.png',
                            iconAnchor: [12, 40],
                            popupAnchor: [0, -41]
                        }),
                        shapeOptions: {
                            clickable: true
                        }
                        
                    },
                    polyline: false,
                    polygon: false,
                    rectangle: false,
                    circle: false,
                    circlemarker: false
                }
                }).addTo(mymap);
            
            
            //create a simple form, data is not permanent
//            var popupContent = '<form role="form" id="form" enctype="multipart/form-data" class = "form-horizontal" onsubmit="addMarker()">'+
//                //datetime
//                '<div class="form-group">'+
//                    '<label class="control-label col-sm-5"><strong>Pysäköintisi päivämäärä ja kellonaika</strong></label>'+
//                    '<input type="date" placeholder="Required" id="date" name="date" class="form-control"/>'+ 
//                '</div>'+
//                
//                //time to search parking
//                '<div class="form-group">'+
//                    '<label class="control-label col-sm-5"><strong>Kuinka pitkään etsit pysäköintipaikkaa (minuuteissa)?: </strong></label>'+
//                    '<input type="number" min="0" max="120" class="form-control" id="parktime" name="parktime">'+ 
//                '</div>'+
//                
//                //likert familiarity of parking area
//                '<div class="row">'+
//                    '<label class="control-label col-sm-5"><strong>Kuinka usein olet pysäköinyt autosi tälle alueelle?</strong></label>'+
//                    '<div class="small-2 column text-right">'+
//                        '<p>strongly agree</p>'+
//                    '</div>'+
//                    '<div class="small-3 column">'+
//                        '<ul class="likert">'+
//                            '<li><input value="1" name="likert" type="radio">Erittäin usein</li>'+
//                            '<li><input value="2" name="likert" type="radio">Usein</li>'+
//                            '<li><input value="3" name="likert" type="radio">Toisinaan</li>'+
//                            '<li><input value="4" name="likert" type="radio">Harvoin</li>'+
//                            '<li><input value="5" name="likert" type="radio">En koskaan</li>'+
//                        '</ul>'+
//                    '</div>'+
//                    '<div class="small-2 column end">'+
//                        '<p>strongly disagree</p>'+
//                    '</div>'+
//                '</div>'+
//                
//                //type of parking spot
//                '<div class="form-group">'+
//                    '<label class="control-label col-sm-5"><strong>Minkätyyppinen pysäköintipaikka oli kyseessä?</strong></label>'+
//                    '<select class="form-control" id="parkspottype" name="parkspottype">'+
//                        '<option value="1">Kadunvarsipaikka</option>'+
//                        '<option value="2">Pysäköintialue (parkkipaikka)</option>'+
//                        '<option value="3">Pysäköintihalli</option>'+
//                        '<option value="4">Muu</option>'+
//                    '</select>'+ 
//                '</div>'+
//                
//                '<button id="button-submit" type="button">Save Changes</button>'+
//                
//                '</form>';
                  
            //determine behaviour of popups
            var popup = L.popup();
            
            function onMapClick(e){
                popup.setLatLng(e.latlng).setContent(e.latlng.toString() + popupContent)
                        .openOn(mymap);
            }
            
            mymap.on(L.Draw.Event.CREATED, function (event) {
                var layer = event.layer;
                var coords = JSON.stringify(layer.toGeoJSON());
                
                layer.on('click', onMapClick); //"mouseover", "click"
                drawnItems.addLayer(layer);
            });

            //try to code remembering buttons
            var buttonSubmit = L.DomUtil.get('button-submit');
                L.DomEvent.addListener(buttonSubmit, 'click', function (e) {
                popup.closePopup();
            });

            // tutki formia: http://embed.plnkr.co/8qVoW5/
            mymap.on('draw:created', function(e) {
                drawnItems.addLayer(e.layer);
//                e.layer.on('click', function(){
//                    if(e.layer.hello){
//                        e.layer.bindPopup(e.layer.hello).openPopup();
//                    } else {
//                        popUpFields = "<button class='add_content'>Add content</button><div class='content_container'></div><button class='popup_save'>Save</button>";
//                        e.layer.bindPopup(popUpFields).openPopup();
//                        $(document).on("click", ".add_content", function(){
//                            $(this).next(".content_container").append("Hello popup!");
//                        });
//                        $('.popup_save').click(function(){
//                            e.layer.hello = $(this).prev().html();
//                        });
//                    };
//                });
            });
            
            // DO I NEED THIS FUNCTIONALITY
//            document.getElementById('export').onclick = function(e) {
//                var data = drawnItems.toGeoJSON();
//                var convertedData = 'text/json;charset=utf-8,' + encodeURIComponent(JSON.stringify(data));
//                document.getElementById('export').setAttribute('href', 'data:' + convertedData);
//                document.getElementById('export').setAttribute('download','data.geojson');
//            };
//            
//            // Truncate value based on number of decimals
//            var _round = function(num, len) {
//                return Math.round(num*(Math.pow(10, len)))/(Math.pow(10, len));
//            };
//
//            // Helper method to format LatLng object (x.xxxxxx, y.yyyyyy)
//            var strLatLng = function(latlng) {
//                return "("+_round(latlng.lat, 6)+", "+_round(latlng.lng, 6)+")";
//            };
//
//            // Object created - bind popup to layer, add to feature group
//            mymap.on(L.Draw.Event.CREATED, function(event) {
//                var layer = event.layer;
//                var content = strLatLng(layer.getLatLng());
//                if (content !== null) {
//                    layer.bindPopup(content);
//                }
//                drawnItems.addLayer(layer);
//            });
//
//            // Object(s) edited - update popups
//            mymap.on(L.Draw.Event.EDITED, function(event) {
//                var layers = event.layers,
//                    content = null;
//
//                layers.eachLayer(function(layer) {
//                    content = getPopupContent(layer);
//                    if (content !== null) {
//                        layer.setPopupContent(content);
//                    }
//                });
//            });
        </script>
    </body>
</html>