<!DOCTYPE html>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<html>
    <head>
        <title>Parking private cars in Helsinki Capital Region</title>
        <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
        <script>L_PREFER_CANVAS=false; L_NO_TOUCH=false; L_DISABLE_3D=false;</script>
        
        <!-- import leaflet and leaflet.draw-->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.4.0/leaflet.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.EasyButton/2.4.0/easy-button.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-ajax/2.1.0/leaflet.ajax.js"></script>
        
        <!--import parking survey variables -->
        <script type="text/javascript" src="park_survey.js"></script>
        <script type="text/javascript" src="survey_info.js"></script>
        
        <!-- my css stylesheet -->
        <link rel="stylesheet" href="style.css">
        
        <!-- other stylesheets -->
        <link href="http://netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.4.0/leaflet.css"/>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.EasyButton/2.4.0/easy-button.css"/>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"/>
        
        <!-- font -->
        <link href="https://fonts.googleapis.com/css?family=Montserrat" rel="stylesheet">
        
        <meta name="viewport" content="width=device-width,
            initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
        
    </head>
    <body>
        <div class="" id="mymap" ></div>
            
        <script>
            // INITIALISE MAP AND LAYERS
            //bounds variables
            var corner1 = [60.41, 24.49];
            var corner2 = [60.086763, 25.305884];
            var bounds = L.latLngBounds(corner1, corner2);
            
            //initialise map
            var mymap = L.map(
                'mymap', {
                center: [60.1743, 24.9356],
                zoom: 13,
                maxBounds: bounds,
                maxBoundsViscosity: 0.8,
                layers: [],
                worldCopyJump: false,
                crs: L.CRS.EPSG3857,
                zoomControl: true
            });
 
            //initialise background tiles
            var tileLayer = L.tileLayer(
                    'https://cartodb-basemaps-{s}.global.ssl.fastly.net/dark_all/{z}/{x}/{y}.png',
                    {
                    "attribution": null,
                    "detectRetina": false,
                    "maxNativeZoom": 18,
                    "maxZoom": 18,
                    "minZoom": 0,
                    "noWrap": false,
                    "opacity": 1,
                    "subdomains": "abc",
                    "tms": false
            }).addTo(mymap);

            // import empty GeoJSON to be populated by user
            var geojson = L.geoJson({
                "type": "FeatureCollection",
                "features": []
                },{
                    onEachFeature: 
                            function (feature, layer){
                                layer.on('click', layerClickHandler);
                            }
                }).addTo(mymap);
            
           
            //import postal codes areas GeoJSON from file
            var postal = new L.GeoJSON.AJAX("pno_research_area.geojson");       
            postal.addTo(mymap);

            //add layer control
            var baseMaps = {
                "tiles": tileLayer,
            };

            var overlayMaps = {
                "Postal areas": postal
            };
            L.control.layers(baseMaps, overlayMaps).addTo(mymap);
           
            //Listen to changeds in form
            //this listener idea from: http://embed.plnkr.co/8qVoW5/
            function layerClickHandler (e) {
                var marker = e.target,
                        properties = e.target.feature.properties;
                
                if(marker.hasOwnProperty('_popup')){
                    marker.unbindPopup();
                }
                
                //check if all values are inserted and print text in popUp
                //if this is the case
                if(!properties.datetime || !properties.likert 
                    || !properties.parkspot || !properties.parktime){
                    marker.bindPopup(popupContent + missingStuff);
                    marker._icon.src = 
                            'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png';
                } else {
                    marker.bindPopup(popupContent);
                    marker._icon.src = 
                            'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png';
                }
                marker.openPopup();

                //EVENT LISTENERS
                //DATETIME
                L.DomUtil.get('datetime').textContent = properties.datetime;
                var dateTime = L.DomUtil.get('datetime');
                dateTime.value = properties.datetime;
                L.DomEvent.addListener(dateTime, "change", function (e){
                    properties.datetime = e.target.value;
                });
                
                //PARKING TIME
                L.DomUtil.get('parktime').textContent = properties.parktime;
                var parkTime = L.DomUtil.get('parktime');
                parkTime.value = properties.parktime;
                L.DomEvent.addListener(parkTime, "change", function (e){
                    properties.parktime = e.target.value;
                });
                
                //LIKERT
                $(L.DomUtil.get('likert')).find(
                        "input[value='" + properties.likert+ "']").attr('checked', true);
                $(document).ready(function(){
                    $('input[name=likert]').click(function(){
                        properties.likert = this.value;
                    });
                });

                //PARKSPOT
                if(typeof currentParkspotValue !== 'undefined'){
                    $(L.DomUtil.get('parkspot')).find(
                            "option[value='" + currentParkspotValue + "']").attr('selected', true);
                    var parkSpot = L.DomUtil.get('parkspot');
                    parkSpot.value = properties.parkspot;
                    L.DomEvent.addListener(parkSpot, "change", function(e){
                        properties.parkspot = e.target.value;
                    });
                } else {
                    L.DomUtil.get('parkspot').value = properties.parkspot;
                    var parkSpot = L.DomUtil.get('parkspot');
                    parkSpot.value = properties.parkspot;
                    L.DomEvent.addListener(parkSpot, "change", function (e){
                        properties.parkspot = e.target.value;
                    });
                }

                //SAVE BUTTON
                var buttonSubmit = L.DomUtil.get('button-submit');
                L.DomEvent.addListener(buttonSubmit, "click", function (e){
                    marker.closePopup();
                });
            }
    

            // POSSIBLE TO FIND FEATURE DATA WITH INTERNAL LAYER ID
            //geojson.getLayer(113).feature.properties.parktime
            function onParkspotChange(event){
                currentParkspotValue = event.target.value;
                //console.log("parkspot value set to " + event.target.value);
            };
    
    
            // INFOTEXT AND INFOBUTTON
            // infotext and infobutton and associated stuff    
            var infoText = L.control({position: 'bottomleft'});
            
            infoText.onAdd = function (map) {
                this._div = L.DomUtil.create('div', 'infotext');
                this.update("");
                return this._div;
            };
            
            infoText.update = function(text){
                this._div.innerHTML = text;
            };
            
            infoText.addTo(mymap);

            var infoBox = L.control({position: 'bottomleft'});
            
            infoBox.onAdd = function (map) {
                this._div = L.DomUtil.create('div', 'infobox');
                this._div.innerHTML = basicInfo;
                return this._div;
            };
            
            var infoButton = L.easyButton({
                states: [{
                    stateName: 'infoOpen',
                    icon: 'fa fa-info',
                    title: 'Avaa info',
                    onClick: function (btn, map) {
                        infoBox.addTo(map);
                        btn.state('infoClose');
                    }
                }, {
                    stateName: 'infoClose',
                    icon: 'fa fa-info',
                    title: 'Sulje info',
                    onClick: function (btn, map) {
                        infoBox.remove(map);
                        btn.state('infoOpen');
                    }
                }]
            });
            infoButton.addTo(mymap);
            
            
            // INFOHEADER
            var infoHeader = L.control();
            infoHeader.onAdd = function (map) {
                this._div = L.DomUtil.create('div', 'infoheader');
                this.update();
                return this._div;
            };
            infoHeader.update = function () {
                this._div.innerHTML = infoHeaderStuff;
            };
            infoHeader.addTo(mymap);
            
            
            // TEE COOKIE JOTTA KÄYTTÄJÄ VOI VALITA KARTTATASON TMS
            // https://www.w3schools.com/js/js_cookies.asp
            //060219 MIKSI MARKER MUUTTUU VIELÄ LYHYESTI SINISEKSI EKAN KERRAN KLIKATESSA
            //MARKERIN KANSSA KARTTAA?
            
            //initialise drawing tools, disable a bunch
            var draw_control = new L.Control.Draw({
                "edit": {
                    "featureGroup": geojson
                },
                "draw": {
                    marker: {
                        icon: new L.Icon({
                            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
                            shadowUrl: 'http://cdn.leafletjs.com/leaflet-0.6.4/images/marker-shadow.png',
                            iconAnchor: [12, 40],
                            popupAnchor: [0, -41]
                        }),
                        shapeOptions: {
                            clickable: true
                        }
                        
                    },
                    polyline: false,
                    polygon: false,
                    rectangle: false,
                    circle: false,
                    circlemarker: false
                }
                }).addTo(mymap);
            
              
              
            //determine behaviour of popups
            //THESE ARE NOT IN USE
            var popup = L.popup();
            
            function onMapClick(e){
                popup.setLatLng(e.latlng).setContent(e.latlng.toString() + popupContent).openOn(mymap);
            }
            
            mymap.on(L.Draw.Event.CREATED, function (e) {
                var layer = e.layer;
                var lat = layer.getLatLng().lat;
                var lng = layer.getLatLng().lng;
                //var coords = JSON.stringify(layer.toGeoJSON());
                var geojsonFeature = {
                        "type": "Feature",
                        "geometry": {
                            "type": "Point",
                            "coordinates": [lng, lat]
                        },
                        "properties":{
                            "datetime": null,
                            "parktime": null,
                            "likert": null,
                            "parkspot": null
                        }
                };
                
                layer.on('click', layerClickHandler); //"mouseover", "click"
                geojson.addData(geojsonFeature);
            });

            mymap.on('draw:created', function(e) {
                var layer = e.layer;
                var lat = layer.getLatLng().lat;
                var lng = layer.getLatLng().lng;
                var geojsonFeature = {
                        "type": "Feature",
                        "geometry": {
                            "type": "Point",
                            "coordinates": [lng, lat]
                        },
                        "properties":{
                            "parktime": null
                        }
                };
                //geojson.addData(geojsonFeature); //JOS TÄÄ OLI KÄYTÖSSÄ, 
                // L.GEOJSONIIN SYNTYY TUPLAT JOKA MERKINNÄSTÄ
                
            });
            
            
             
            // DO I NEED THIS FUNCTIONALITY??
//            document.getElementById('export').onclick = function(e) {
//                var data = drawnItems.toGeoJSON();
//                var convertedData = 'text/json;charset=utf-8,' + encodeURIComponent(JSON.stringify(data));
//                document.getElementById('export').setAttribute('href', 'data:' + convertedData);
//                document.getElementById('export').setAttribute('download','data.geojson');
//            };
//            
            // Truncate value based on number of decimals
            var _round = function(num, len) {
                return Math.round(num*(Math.pow(10, len)))/(Math.pow(10, len));
            };

            // Helper method to format LatLng object (x.xxxxxx, y.yyyyyy)
            var strLatLng = function(latlng) {
                return "("+_round(latlng.lat, 6)+", "+_round(latlng.lng, 6)+")";
            };
//
//            // Object created - bind popup to layer, add to feature group
//            mymap.on(L.Draw.Event.CREATED, function(event) {
//                var layer = event.layer;
//                var content = strLatLng(layer.getLatLng());
//                if (content !== null) {
//                    layer.bindPopup(content);
//                }
//                drawnItems.addLayer(layer);
//            });
//
//            // Object(s) edited - update popups
//            mymap.on(L.Draw.Event.EDITED, function(event) {
//                var layers = event.layers,
//                    content = null;
//
//                layers.eachLayer(function(layer) {
//                    content = getPopupContent(layer);
//                    if (content !== null) {
//                        layer.setPopupContent(content);
//                    }
//                });
//            });
        </script>
    </body>
</html>