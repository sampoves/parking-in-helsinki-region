<!DOCTYPE html>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<html>
    <head>
        <title>Parking private cars in Helsinki Capital Region</title>
        <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
        <script>L_PREFER_CANVAS=false; L_NO_TOUCH=false; L_DISABLE_3D=false;</script>
        
        <!-- import leaflet, leaflet.draw and other needed libraries-->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.4.0/leaflet.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.EasyButton/2.4.0/easy-button.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-ajax/2.1.0/leaflet.ajax.js"></script>
        <script src="https://unpkg.com/@mapbox/leaflet-pip@latest/leaflet-pip.js"></script>
        
        <!--import parking survey variables -->
        <script type="text/javascript" src="park_survey.js"></script>
        <script type="text/javascript" src="survey_info.js"></script>
        <script type="text/javascript" src="survey_funcs.js"></script>
        
        <!-- my css stylesheet -->
        <link rel="stylesheet" href="style.css">
        
        <!-- other stylesheets -->
        <link href="http://netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.4.0/leaflet.css"/>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.EasyButton/2.4.0/easy-button.css"/>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"/>
        
        <!-- font -->
        <link href="https://fonts.googleapis.com/css?family=Montserrat" rel="stylesheet">
        
        <meta name="viewport" content="width=device-width,
            initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
        
    </head>
    <body>
        <div class="" id="mymap" ></div>
            
        <script>
    //Alkututorial??
    //SCRIPT omaan js-tiedostoon
    //Sivulle kun tulee niin pitäisi käyttäjälle tulla jotain infoa että mitä pitäisi tehdä
    //Kun pisteen on lisännyt olisi hyvä jos kyselypopup aukeaisi automaattisesti
            
            //COOKIE
            //console.log(document.cookie + " ennen definitonii");
            //console.log(document.cookie === "survey_tilelayer_choice=Stamen terrain");
            
            

            
            // INITIALISE MAP AND LAYERS
            //bounds variables
            var corner1 = [60.5, 24.37];
            var corner2 = [60.05, 25.305884];
            var bounds = L.latLngBounds(corner1, corner2);
            
            //initialise map
            var mymap = L.map(
                'mymap', {
                center: [60.1743, 24.9356],
                zoom: 13,
                maxBounds: bounds,
                maxBoundsViscosity: 0.8,
                layers: [],
                worldCopyJump: false,
                crs: L.CRS.EPSG3857,
                zoomControl: true
            });
 
            //events to listen for baselayer or overlay change for to use of 
            //cookies
            //https://leafletjs.com/reference-1.4.0.html#map-baselayerchange
            mymap.on('baselayerchange', function(e) {
                console.log(e.name + " tallennettu cookieen");
                var cookie_name = "survey_tilelayer_choice";
                var cookie_value = e.name;
                create_cookie(cookie_name, cookie_value, 90, "/");
            });
 
            //initialise background tiles
            //CartoDB dark_matter
            var darkmatter = L.tileLayer(
                    'https://cartodb-basemaps-{s}.global.ssl.fastly.net/dark_all/{z}/{x}/{y}.png',
                {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                    "detectRetina": false,
                    "maxNativeZoom": 18,
                    "maxZoom": 18,
                    "minZoom": 0,
                    "noWrap": false,
                    "opacity": 1,
                    "subdomains": "abc",
                    "tms": false
            });//.addTo(mymap); //this used to be default here

            //OpenStreetMap
            var OpenStreetMap_DE = L.tileLayer('https://{s}.tile.openstreetmap.de/tiles/osmde/{z}/{x}/{y}.png', {
                    minZoom: 0,
                    maxZoom: 18,
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            });

            //Stamen terrain
            var Stamen_Terrain = L.tileLayer('https://stamen-tiles-{s}.a.ssl.fastly.net/terrain/{z}/{x}/{y}{r}.{ext}', {
                    attribution: 'Map tiles by <a href="http://stamen.com">Stamen Design</a>, <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a> &mdash; Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                    subdomains: 'abcd',
                    minZoom: 0,
                    maxZoom: 18,
                    ext: 'png'
            });
            
            //use .addTo() to give mymap the correct cookie value
            if(document.cookie === "survey_tilelayer_choice=CartoDB dark_matter"){
                darkmatter.addTo(mymap);
            } else if (document.cookie === "survey_tilelayer_choice=OpenStreetMap") {
                OpenStreetMap_DE.addTo(mymap);
            } else if (document.cookie === "survey_tilelayer_choice=Stamen terrain"){
                Stamen_Terrain.addTo(mymap);
            } else {
                darkmatter.addTo(mymap);
            }
            
            //MITEN SAADA POPUP AUKI HETI MARKERIN KIINNITÄMISEN JÄLKEEN?
            // yks johtolanka: https://jsfiddle.net/emmalivingstone/abpee1ym/

            // import empty GeoJSON to be populated by user with responses
            var delay=1000, setTimeoutConst;
            
            var geojson = L.geoJson({
                "type": "FeatureCollection",
                "features": []
                },{
                    onEachFeature:
                            function (feature, layer){
                                //($(layer));
                                layer.on('click', layerClickHandler);
                            }
                }).addTo(mymap);
            
            // BACKGROUND GEOJSON LAYERS
            //import postal codes areas GeoJSON from file
            var stylePostal = {
                "color": "#ff7800",
                "weight": 3,
                "opacity": 0.4,
                "fillOpacity": 0
            };        
    
            var styleArea = {
                "color": "#ff7800",
                "weight": 3,
                "opacity": 0.3,
                "fillColor": '#0000FF',
                "fillOpacity": 0,
                "jeejee": 0 //this helps me detect research area MultiPolygon later on
            };   
            
            var stylePien = {
                "color": "#f316f7",
                "weight": 3,
                "opacity": 0.3,
                "fillColor": '#0000FF',
                "fillOpacity": 0
            };   
           
            var postal = new L.GeoJSON.AJAX(
                    "pno_research_area.geojson", {
                        style: stylePostal
            }).addTo(mymap);
            
            var postaldissolve = new L.GeoJSON.AJAX(
                    "pno_dissolve.geojson", {
                        style: styleArea
            }).addTo(mymap);
                        
            var pienalue = new L.GeoJSON.AJAX(
                    "seutukartta_pienalue.geojson", {
                        style: stylePien
            });//.addTo(mymap);

            //add layer control
            var baseMaps = {
                "OpenStreetMap": OpenStreetMap_DE,
                "CartoDB dark_matter": darkmatter,
                "Stamen terrain": Stamen_Terrain
            };

            var overlayMaps = {
                "Seutukartta pienalue": pienalue,
                "Postal areas": postal,
                "Research area": postaldissolve
            };
            L.control.layers(baseMaps, overlayMaps).addTo(mymap);
           
           //add additional text to layer control
           $('<p id="controlTitle1"><strong>Taustakartat<strong></p>').insertBefore('div.leaflet-control-layers-base');
           $('<p id="controlTitle2"><strong>Aluejaot<strong></p>').insertBefore('div.leaflet-control-layers-overlays');
    
           //overlay highlighting
            var pienalueHighlight = {
                'color': '#d738ff',
                'weight': 2,
                'opacity': 1,
                "fillColor": '#0000FF',
                "fillOpacity": 0.1
            };
            
            var postalHighlight = {
                'color': '#ffd711',
                'weight': 2,
                'opacity': 1,
                "fillColor": '#ff9e28',
                "fillOpacity": 0.1
            };
                        
            //highlight overlay layers on mouseover. Also listen to return to 
            //normal.
            pienalue.on("mouseover", highlightLayer);
            pienalue.on("mouseout", layerToNormal);
            postal.on("mouseover", highlightLayer);
            postal.on("mouseout", layerToNormal);


            //default icon options
            //DOES NOT WORK
            L.Icon.Default.prototype.options = {
                iconUrl: "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png",
                shadowUrl: "https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png",
                shadowAnchor: [8, 20],
                shadowSize: [25, 18],
                iconAnchor: [12, 40],
                popupAnchor: [0, -41]
            };
            
            //incomplete icon
            var incompleteIcon = L.Icon.extend({
                options: {
                    iconUrl: "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png",
                    shadowUrl: "https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png",
                    shadowAnchor: [8, 20],
                    shadowSize: [25, 18],
                    iconAnchor: [12, 40],
                    popupAnchor: [0, -41]
                }
            });
            
            //complete icon
            var completeIcon = L.Icon.extend({
                options: {
                    iconUrl: "https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png",
                    shadowUrl: "https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png",
                    shadowAnchor: [8, 20],
                    shadowSize: [25, 18],
                    iconAnchor: [12, 40],
                    popupAnchor: [0, -41]
                }
            });
            
            
            //Listen to changes in form
            //this listener idea from: http://embed.plnkr.co/8qVoW5/
            function layerClickHandler (e) {
                
                //MARKER LOCATION INTERSECTED WITH OVERLAY LAYERS
                //Check with conditional statement what to print on popup.
                //delete is necessary to remove unwanted values in popup when
                //first placing popup on research area and then placing a popup
                //outside. This would result to an erroneous result
                hitPostal = findIntersection(e.latlng, postal);
                hitPienalue = findIntersection(e.latlng, pienalue);
                
                if (hitPostal === "" && hitPienalue === ""){
                    html = '<font size="2" color="red" style="line-height: 30px;"><center><strong>Outside research area!</strong></center></font>';
                } else if (hitPienalue === "") {
                    html = "Postinumeroalue: " + hitPostal[0].feature.properties.nimi, hitPostal[0].feature.properties.posti_alue;
                    delete hitPostal;
                } else if (hitPostal === ""){
                    html = "Pienalue: " + hitPienalue[0].feature.properties.nimi;
                    delete hitPienalue;
                } else if (hitPostal !== "" && hitPienalue !== "") {
                    html = "Pienalue: " + hitPienalue[0].feature.properties.nimi + "<br> Postinumeroalue: " + hitPostal[0].feature.properties.nimi + " " + hitPostal[0].feature.properties.posti_alue;
                    delete hitPostal;
                    delete hitPienalue;
                }

                
                var marker = e.target,
                        properties = e.target.feature.properties;
                
                if(marker.hasOwnProperty('_popup')){
                    marker.unbindPopup();
                }
                
                //check if all values are inserted and print text in popUp
                //if this is the case
                if(!properties.datetime || !properties.likert 
                    || !properties.parkspot || !properties.parktime){
                    marker.bindPopup(html + popupContent + missingStuff);
                    e.target.setIcon(new incompleteIcon);
                    //marker._icon.src = 
                    //       'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png';
                } else {
                    marker.bindPopup(popupContent);
                    e.target.setIcon(new completeIcon);
                    //marker._icon.src = 
                    //        'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png';
                }
                marker.openPopup();

                //EVENT LISTENERS
                //DATETIME
                L.DomUtil.get('datetime').textContent = properties.datetime;
                var dateTime = L.DomUtil.get('datetime');
                dateTime.value = properties.datetime;
                L.DomEvent.addListener(dateTime, "change", function (e){
                    properties.datetime = e.target.value;
                });
                
                //PARKING TIME
                L.DomUtil.get('parktime').textContent = properties.parktime;
                var parkTime = L.DomUtil.get('parktime');
                parkTime.value = properties.parktime;
                L.DomEvent.addListener(parkTime, "change", function (e){
                    properties.parktime = e.target.value;
                });
                
                //LIKERT
                $(L.DomUtil.get('likert')).find(
                        "input[value='" + properties.likert+ "']").attr('checked', true);
                $(document).ready(function(){
                    $('input[name=likert]').click(function(){
                        properties.likert = this.value;
                    });
                });

                //PARKSPOT
                if(typeof currentParkspotValue !== 'undefined'){
                    $(L.DomUtil.get('parkspot')).find(
                            "option[value='" + currentParkspotValue + "']").attr('selected', true);
                    var parkSpot = L.DomUtil.get('parkspot');
                    parkSpot.value = properties.parkspot;
                    L.DomEvent.addListener(parkSpot, "change", function(e){
                        properties.parkspot = e.target.value;
                    });
                } else {
                    L.DomUtil.get('parkspot').value = properties.parkspot;
                    var parkSpot = L.DomUtil.get('parkspot');
                    parkSpot.value = properties.parkspot;
                    L.DomEvent.addListener(parkSpot, "change", function (e){
                        properties.parkspot = e.target.value;
                    });
                }

                //SAVE BUTTON
                var buttonSubmit = L.DomUtil.get('button-submit');
                L.DomEvent.addListener(buttonSubmit, "click", function (e){
                    marker.closePopup();
                });
            }
    



            // INFOTEXT AND INFOBUTTON
            // infotext and infobutton and associated stuff    
            var infoText = L.control({position: 'bottomleft'});

            infoText.onAdd = function (map) {
                this._div = L.DomUtil.create('div', 'infotext');
                this.update("");
                return this._div;
            };
            
            infoText.update = function(text){
                this._div.innerHTML = text;
            };
            infoText.addTo(mymap);


            var infoBox = L.control({position: 'bottomleft'});
            
            infoBox.onAdd = function (map) {
                this._div = L.DomUtil.create('div', 'infobox');
                this._div.innerHTML = basicInfo;
                return this._div;
            };
            
            var infoButton = L.easyButton({
                states: [{
                    stateName: 'infoOpen',
                    icon: 'fa fa-info',
                    title: 'Avaa info',
                    onClick: function (btn, map) {
                        infoBox.addTo(map);
                        btn.state('infoClose');
                    }
                }, {
                    stateName: 'infoClose',
                    icon: 'fa fa-info',
                    title: 'Sulje info',
                    onClick: function (btn, map) {
                        infoBox.remove(map);
                        btn.state('infoOpen');
                    }
                }]
            });
            infoButton.addTo(mymap);
            
            
            // INFOHEADER
            var infoHeader = L.control();
            infoHeader.onAdd = function (map) {
                this._div = L.DomUtil.create('div', 'infoheader');
                this.update();
                return this._div;
            };
            infoHeader.update = function () {
                this._div.innerHTML = infoHeaderStuff;
            };
            infoHeader.addTo(mymap);
            
           
            //060219 MIKSI MARKER MUUTTUU VIELÄ LYHYESTI SINISEKSI EKAN KERRAN KLIKATESSA
            //MARKERIN KANSSA KARTTAA?
            
            //initialise drawing tools, disable a bunch of feature types
            var draw_control = new L.Control.Draw({
                "edit": {
                    "featureGroup": geojson
                },
                "draw": {
                    marker: {
                        icon: new L.Icon({
                            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
                            shadowUrl: 'http://cdn.leafletjs.com/leaflet-0.6.4/images/marker-shadow.png',
                            iconAnchor: [12, 40],
                            popupAnchor: [0, -41]
                        }),
                        shapeOptions: {
                            clickable: true
                        }
                        
                    },
                    polyline: false,
                    polygon: false,
                    rectangle: false,
                    circle: false,
                    circlemarker: false
                }
            }).addTo(mymap);
            
            //enable this to have marker placement on right at page load
            new L.Draw.Marker(mymap, draw_control.options.marker).enable();
            
            //disable double click zoom and enable double click marker creation
            mymap.doubleClickZoom.disable(); 
            mymap.on("dblclick", function (e){
                new L.Draw.Marker(mymap, draw_control.options.marker).enable();
            });
            
            mymap.on(L.Draw.Event.CREATED, function (e) {
                var layer = e.layer;
                var lat = layer.getLatLng().lat;
                var lng = layer.getLatLng().lng;
                var geojsonFeature = {
                        "type": "Feature",
                        "geometry": {
                            "type": "Point",
                            "coordinates": [lng, lat]
                        },
                        "properties":{
                            "datetime": null,
                            "parktime": null,
                            "likert": null,
                            "parkspot": null
                        }
                };
                layer.on('click', layerClickHandler); //"mouseover", "click"
                geojson.addData(geojsonFeature);
            });

            mymap.on('draw:created', function(e) {
                var layer = e.layer;
                var lat = layer.getLatLng().lat;
                var lng = layer.getLatLng().lng;
                var geojsonFeature = {
                        "type": "Feature",
                        "geometry": {
                            "type": "Point",
                            "coordinates": [lng, lat]
                        },
                        "properties":{
                            "parktime": null
                        }
                };
                
            });
            
//
//            // Object created - bind popup to layer, add to feature group
//            mymap.on(L.Draw.Event.CREATED, function(event) {
//                var layer = event.layer;
//                var content = strLatLng(layer.getLatLng());
//                if (content !== null) {
//                    layer.bindPopup(content);
//                }
//                drawnItems.addLayer(layer);
//            });
//
            // Object(s) edited - update popups
            mymap.on(L.Draw.Event.EDITED, function(event) {
                var layers = event.layers,
                    content = null;

                layers.eachLayer(function(layer) {
                    content = getPopupContent(layer);
                    if (content !== null) {
                        layer.setPopupContent(content);
                    }
                });
            });
        </script>
    </body>
</html>