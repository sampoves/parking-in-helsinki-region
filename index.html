<!DOCTYPE html>
<!--
This Leaflet popup survey is written by Sampo Vesanen with the generous help
of various StackExchange questions. All rights reserved. Created for University 
of Helsinki master's thesis "Parking of private cars and accessibility in 
Helsinki Capital Region".
-->
<html>
    <head>
        <title>Parking private cars in Helsinki Capital Region</title>
        <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
        <script>L_PREFER_CANVAS=false; L_NO_TOUCH=false; L_DISABLE_3D=false;</script>
        
        <!-- import leaflet, leaflet.draw and other needed libraries-->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.4.0/leaflet.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.EasyButton/2.4.0/easy-button.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-ajax/2.1.0/leaflet.ajax.js"></script>
        <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
        
        <!--favicon provided by Clipart Library:
        http://clipart-library.com/clipart/LidobpK4T.htm-->
        <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico">
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
        
        <!--import parking survey variables -->
        <script type="text/javascript" src="park_survey.js"></script>
        <script type="text/javascript" src="survey_funcs.js"></script>
        <script type="text/javascript" src="survey_vars.js"></script>
        
        <!-- survey css stylesheet -->
        <link rel="stylesheet" href="style.css">
        
        <!-- other stylesheets -->
        <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.4.0/leaflet.css"/>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.EasyButton/2.4.0/easy-button.css"/>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.css"/>
        <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css"/>

        <!-- font -->
        <link href="https://fonts.googleapis.com/css?family=Montserrat" rel="stylesheet">
        
        <meta name="viewport" content="width=device-width,
            initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
    </head>
    <body>
        <div class="" id="mymap"></div>
            
        <script>
            //--------------
            //INITIALISATION
            //--------------
            //
            // INITIALISE MAP AND LAYERS
            //initialise map
            var mymap = L.map(
                'mymap', {
                center: [60.1743, 24.9356],
                zoom: 13,
                maxBounds: bounds,
                maxBoundsViscosity: 0.8,
                layers: [],
                worldCopyJump: false,
                crs: L.CRS.EPSG3857,
                zoomControl: true,
                // Allow popups to be closed only with buttons. This improves
                // mobile user experience
                closePopupOnClick: false 
            });
            
            // Initialise TrackZipCodes object for keeping track of unique zip
            // codes. This prevents duplicate records for same zip code areas.
            // UIState keeps track for unfinished areas dialog box whether
            // UI has been hidden or not.
            usersZipCodes = new TrackZipCodes();
            window.UIState = true;
            
            // Once page has loaded, carry out some commands:
            //- submit button is disabled by default
            //- set postal geojson layer as topmost
            //- prevent enter keystrokes (this would lead to accidental page 
            //refreshes)
            //- listen to clicks on geocoder button
            $(document).ready(function(){
                
                //disable submit button by default
                sendBox.disable();
                
                window.unfinishedPopups = 0;
                
                //prevent functionality of enter. Also prevents mobile numpad
                //enter functions.
                $(window).keydown(function(event){
                    if(event.keyCode === 13) {
                        event.preventDefault();
                        return false;
                    }
                });
                
                //listen to clicks on geocoder button. Don't allow popup or
                //infobox be open while searching. There is a slight bug when
                //clicking on geocoder while infobox is open: geocoder immediately
                //closes with infobox. Two clicks needed
                $(".leaflet-control-geocoder").on("click", function() {
                    mymap.closePopup();
                    $("#tabsikkuna").dialog("close");
                    infoButton.state('infoOpen');
                });
            });

            //Show survey version in jQuery info window and determine whether
            //to start survey in mobile mode or not. Also, execute visitor
            //counter code.
            var survey_version = "Survey version 16.5.2019";
            window.onload = function() {
                document.getElementById('version').innerHTML = survey_version;
                
                // Handle correct translation of mobilewarning
                if(currentLang === "fi") {
                    smallscreen = mobilewarning_smallscreen_fi;
                    general = mobilewarning_general_fi;
                } else {
                    smallscreen = mobilewarning_smallscreen;
                    general = mobilewarning_general;
                }
                
                // If user's window width is less than 800, show message about
                // how to proceed
                if($(window).width() < 800) {
                    
                    document.getElementById('mobilewarning').innerHTML = 
                            smallscreen;
            
                    // If there is no value in cookie "device", set it in mobile.
                    // Now a mobile user will see the mobile version at first,
                    // but they can change that to desktop if they want
                    if(typeof getCookie("device") === "undefined") {
                        create_cookie("device", "mobile", 90, "/");
                    }
                    
                //detect visits with mobile phone which have larger screen than
                //800 pixels wide.
                } else if (L.browser === "mobile") {
                    document.getElementById('mobilewarning').innerHTML = 
                            general;
                } else {
                    // This condition is fulfilled, if user's screen is large
                    // enough and browser is not mobile. This is to make sure
                    // infobox will not show an empty speech bubble
                    $("#mobilewarning").css("display", "none");
                }
                
                //Execute visitor counter. Send dummy data to validate our post
                //request (to bypass empty post request detection).
                $.post('unique_visitors.php', {dummy: 1337}, function(responseFromServer) {
                    //PHP working its magic
                }, "text").done(function(responseFromServer) {
                    console.log(responseFromServer);
                });
            };
            


            //------------
            //MYMAP EVENTS
            //------------
            
            //this listens to all clicks in the document and if the following
            //if statements are true, then we are on mobile mode and UI is
            //hidden. After a click wait 200ms and then test the statements.
            //If everything passes, show UI again. This should take make sure
            //user is not left without UI at any moment.
            "click touchend touchstart".split(" ").forEach(function(e){
                document.addEventListener(e, function (event) {
                    testUIstate();
                });
            });

            
            //Pane for label tile layers. This will keep tile layer labels on
            //top of GeoJSON Polygons
            mymap.createPane('labels');
            mymap.getPane('labels').style.zIndex = 650;
            mymap.getPane('labels').style.pointerEvents = 'none';
            
            //Due to a unknown issue in this code GeoJSON layer postaldissolve
            //would get a higher zIndex than postal in most of the times when
            //loading the survey. This relegates postaldissolve to its own map
            //pane which is located in a low level in the zIndex hierarchy.
            mymap.createPane('researcharea');
            mymap.getPane('researcharea').style.zIndex = 201;
            mymap.getPane('researcharea').style.pointerEvents = 'none';
            
            
            //events to listen for baselayer or overlay change for to use of 
            //cookies
            //https://leafletjs.com/reference-1.4.0.html#map-baselayerchange
            mymap.on('baselayerchange', function(e) {
                console.log(`${e.name} set in cookie`);
                var cookie_name = "survey_tilelayer_choice";
                var cookie_value = e.name;
                create_cookie(cookie_name, cookie_value, 90, "/");
                
                //Listen to baselayerchange and change geojson layer style
                //accordingly
                //also make note addition or removal of darkmatter labels
                changeOfLabels();
                
                if(mymap.hasLayer(OpenStreetMap_DE)){
                    voyagerOnlyLabels.addTo(mymap);
                    postal.setStyle(stylePostalDark);
                    postaldissolve.setStyle(styleAreaDark);
                } 
                else if (mymap.hasLayer(Stamen_Terrain)){
                    StamenTerrainOnlyLabels.addTo(mymap);
                    postal.setStyle(stylePostalDark);
                    postaldissolve.setStyle(styleAreaDark);
                } 
                else if (mymap.hasLayer(darkmatter)){
                    darkmatterOnlyLabels.addTo(mymap);
                    postal.setStyle(stylePostal);
                    postaldissolve.setStyle(styleArea);
                }
            });
            
            // Disable double click zoom
            mymap.doubleClickZoom.disable(); 

            //Listen to additions to overlays: always keep geojson layer on top.
            //Also make sure that "postal" is always on top of "postaldissolve".
            //This is realised with first bringing postal on top, then geojson.
            mymap.on("overlayadd", function (event) {
                postal.bringToFront();
            });
            
            //on dragstart, check if popups are finished and button can be 
            //activated. Same for click. These events may be expensive to run.
            mymap.on("dragstart", function (e) {
                updateGeomColors();
                arePopupsFinished();
                //unfinishedBox.update();
            });
            
            mymap.on("click", function (e) {
                updateGeomColors();
                arePopupsFinished();
                unfinishedBox.update();
            });

            //With the 190419 addition of walktime, the topmost part of survey 
            //popup, zipcode, would easily get cut off screen. This event will 
            //make sure that will not happen.
            //Code by Dan Mandle, https://stackoverflow.com/a/23960984/9455395
            mymap.on('popupopen', function(e) {

                // Find the pixel location on the map where the popup anchor is
                var px = mymap.project(e.popup._latlng);
                
                // Find the height of the popup container, divide by 2, subtract 
                // from the Y axis of marker location
                px.y -= e.popup._container.clientHeight / 2; 
                
                // Pan to new center, if helper variable apu is 0 (a popup is
                // not open
                //if (apu === 0) {
                mymap.panTo(mymap.unproject(px), {animate: true});
                //}
            });

            //-------
            //COOKIES
            //-------
            //
            //COOKIES: SET SITE LANGUAGE WITH COOKIE VALUE
            var currentLang = null;
            $(document).ready(function(){
                if(getCookie("lang") === "fi"){
                    console.log("Finnish detected from cookie, set language as Finnish");
                    $.getJSON('fi.json', translate);
                    window.currentLang = "fi";
                } else {
                    console.log("Value in cookie was not Finnish, default to English");
                    $.getJSON('en.json', translate);
                    window.currentLang = "en";
                    
                    //force language button state to the correct once when the
                    //page is fully loaded
                    $(document).ready(function() {
                        langButton.state("en");
                    });
                }
            });
            
            
            //COOKIES POPUP SIZE. SURVEY REMEMBERS WHICH SIZE USER HAS SELECTED
            $(document).ready(function() {
                if (getCookie("popupsize") === "default") {
                    $("div.popupsize").attr("content", "large (default)");
                    console.log("Popup size value default detected");

                } else if (getCookie("popupsize") === "small") {
                    $("div.popupsize").attr("content", "small");
                    console.log("Popup size value small detected");

                } else if (getCookie("popupsize") === "medium") {
                    $("div.popupsize").attr("content", "medium");
                    console.log("Popup size value medium detected");
                } else {
                    //if no popupsize value is detected, test if we are on
                    //small screen or other mobile phone. 
                    if(($(window).width() < 800) || (L.browser === "mobile")) {
                        // If statement is true, we are on mobile or other device
                        // with a small screen. An user will now see the 
                        // popup size a bit smaller at first, making it easier 
                        // to understand how to use the survey.
                        create_cookie("popupsize", "medium", 90, "/");
                        $("div.popupsize").attr("content", "medium");
                        console.log("Popup size value not found, user on mobile, set medium size");
                    } else {
                        // We are on desktop
                        create_cookie("popupsize", "default", 90, "/");
                        $("div.popupsize").attr("content", "large (default)");
                        console.log("Popup size value not found, user on desktop, set default size");
                    }
                }
                //translate popup size value
                cssPopupsizeValue();
            });
            

            //COOKIES: SET USER SETTINGS STRAIGHT WITH COOKIE VALUES
            //use .addTo() to give mymap the correct cookie value
            if(getCookie("survey_tilelayer_choice") === "CartoDB dark_matter"){
                darkmatter.addTo(mymap);
                darkmatterOnlyLabels.addTo(mymap);
            } 
            else if (getCookie("survey_tilelayer_choice") === "OpenStreetMap") {
                OpenStreetMap_DE.addTo(mymap);
                voyagerOnlyLabels.addTo(mymap);
            } 
            else if (getCookie("survey_tilelayer_choice") === "Stamen terrain"){
                Stamen_Terrain.addTo(mymap);
                StamenTerrainOnlyLabels.addTo(mymap);
            } else {
                //this is the case if first launch: no cookie set, set OSM
                //on as default
                OpenStreetMap_DE.addTo(mymap);
                voyagerOnlyLabels.addTo(mymap);
            }
            
            //COOKIES: Has jQuery infobox commanded to stay away at start?
            $(document).ready(function(){
                if(getCookie("info_closed_once") === "yes"){
                    console.log("Cookie value found, hide survey information popup");
                    
                    //these two jQuery commands help prevent creating new
                    //Polygon records to geojson by preventing geojsonFeature
                    //creation on "postal.on("click"...)
                    $("#tabsikkuna").dialog();
                    $("#tabsikkuna").dialog("close");
                    infoButton.state('infoOpen');
                } else {
                    //user visiting first time or hasn't pressed "stop showing..."
                    //button
                    console.log("Associated cookie value not found, show survey information popup");

                    //initialise jQuery UI dialog and tabs through this
                    //function
                    $(initialiseInfo);
                    infoButton.state('infoClose');
                    
                    //This listens to the first time infobox is close with x.
                    //Without this listener the infobutton does not update
                    //correctly on the first closing.
                    $(document).ready(function(){
                        $(".ui-dialog-titlebar-close").one('click', function(e) {
                            infoButton.state('infoOpen');
                        });
                    });
                }
            });
            


            //-------------------------
            //INITIALISE GEOJSON LAYERS
            //-------------------------
            //
            // Initialise empty GeoJSON to be populated by user with responses
            var geojson = L.geoJson({
                "type": "FeatureCollection",
                "features": []
                },{
                    closePopupOnClick: false,
                    onEachFeature:
                            function (feature, layer){
                                if($(".leaflet-popup-content-wrapper").length === 0) {
                                    layer.on('click', layerClickHandler);
                                };

                                //incompleteTest() accepts onEachFeature "feature"
                                //or layer event
                                if(incompleteTest(feature) === true){
                                    layer.setStyle(geojsonIncomplete);
                                } else {
                                    layer.setStyle(geojsonComplete);
                                }
                            }
                }).addTo(mymap);

            // IMPORT POLYGON GEOJSONS
            // Note: bug suspicion in Leaflet 1.4.0. Laying out style function 
            // like here seems to work unexpectedly. It always picks one 
            // geometry where the style defaults to blue. This is acceptable 
            // for postal, but not for postaldissolve. For this reason the code 
            // is commented in postaldissolve's style parameter.
            var postal = new L.GeoJSON.AJAX(
                    "pno_research_area.geojson", {
                        attribution: 'Postal code areas &copy; <a href="http://urn.fi/urn:nbn:fi:csc-kata20180425144903846834">Statistics Finland</a>, <a href="http://creativecommons.org/licenses/by/4.0">CC BY 4.0</a>',
                        //style function listens to baselayer change and chooses
                        //GeoJSON layer postal style accordingly
                        style: function(feature){
                            if(mymap.hasLayer(darkmatter)){
                                postal.setStyle(stylePostal);
                            } else if (mymap.hasLayer(OpenStreetMap_DE)){
                                postal.setStyle(stylePostalDark);
                            } else if (mymap.hasLayer(Stamen_Terrain)){
                                postal.setStyle(stylePostalDark);
                            };
                        }
                }).addTo(mymap);
                 
            var postaldissolve = new L.GeoJSON.AJAX(
                    "pno_dissolve.geojson", {
                        pane: 'researcharea',
                        style: styleArea
//                        style: function(layer){
//                            if(mymap.hasLayer(darkmatter)){
//                                postaldissolve.setStyle(styleArea);
//                            } else if (mymap.hasLayer(OpenStreetMap_DE)){
//                                postaldissolve.setStyle(styleAreaDark);
//                            } else if (mymap.hasLayer(Stamen_Terrain)){
//                                postaldissolve.setStyle(styleAreaDark);
//                            };
//                        }
            }).addTo(mymap);

            //this does not load as expected at page finish. commented
//            $(document).ready(function(){
//                window.stylingFunction(postal, stylePostal, stylePostalDark);
//                window.stylingFunction(postaldissolve, styleArea, styleAreaDark);
//            });
 
 
 
            //--------------------
            //GEOJSON LAYER EVENTS
            //--------------------
            //
            //Highlight overlay layers on mouseover. Also listen to return to 
            //normal.   
            postal.on("mouseover", highlightLayer);
            postal.on("mouseout", layerToNormal);
            geojson.on("mouseover", highlightGeojson);
            geojson.on("mouseout", geojsonToNormal);
                      
            //This event opens popup when clicking on a new postal code area.
            //fire() simulates a second click on the Polygon, as without this
            //command one would need to click a new Polygon two times to open
            //corresponding popup. This happened, because first user clicks
            //on the layer "postal", which doesn't fire up function 
            //layerClickHandler(). layerClickHandler() is only fired up when
            //user clicks the second time on the Polygon, which now exists on
            //a topmost layer "geojson".
            geojson.on("layeradd", function(event){
                thisLayer = event.layer;
                thisLayer.fire("click");
            });
            
            
            //On layer click on "postal", initialise "geojsonFeature" and add it 
            //to the "geojson" layer.
            postal.on("click", function (e) {
                               
                // If statement tests if the following class is open. It gets
                // value 1 if it is, otherwise 0. This prevents inadvertent
                // additions of Polygons when clicking away from the popup.
                // The following if statement also prevents creating new 
                // Polygons when a jQuery dialog box is open, be it infobox or 
                // successbox.
                if(($(".leaflet-popup-content-wrapper").length === 0) && 
                        (($("#tabsikkuna").is(":visible") === false) && 
                        ($("#sucdialog").is(":visible") === false))) {
                    var layer = e.layer;
                    var pol = layer.toGeoJSON();
                    var geom = pol.geometry;
                    var geojsonFeature = {
                            "type": "Feature",
                            "geometry": geom,
                            "properties": {
                                "zipcode": layer.feature.properties.posti_alue,
                                "parktime": null,
                                "walktime": null,
                                "likert": null,
                                "parkspot": null,
                                "timeofday": null
                            }
                    };

                    //Only add data to "geojson" if user has never clicked on
                    //the postal area being clicked. Boolean true means that 
                    //zipcode entered is unique.
                    if(usersZipCodes.addUniqueZipCode(
                            e.layer.feature.properties.posti_alue) === true){
                        geojson.addData(geojsonFeature);
                    }
                }
            });
            


            // This bit here prevents the immediate opening of a new popup on
            // layer geojson if a popup is already open. This behaviour would
            // temporarily screw up the display of inserted records and would
            // break the "save changes" and "delete records" buttons. With this
            // code we keep track 1) if a popup is open, 2) what is the state
            // of the helper variable "apu". Apu gets the value of 0 if a popup
            // can be opened and 1 if it is not allowed. Apu is manipulated not
            // only here. We need to change its value on postal click and when
            // clicking save changes, x button and delete records.
            geojson.on("click", function(e){
                //This prevents opening popups when infobox or success dialog
                //is open. Only works with click on layer geojson
                if(($("#tabsikkuna").is(":visible") === true) || 
                        ($("#sucdialog").is(":visible") === true)) {
                    mymap.closePopup();
                    
                    // If user would click on geojson layer while info dialog
                    // is open, the normal click functionality of clicked
                    // features would not work anymore. This fixes the situation.
                    enableClicksOnLayer();
                }
            });
            


            //------------------------
            //LAYER CONTROL ELEMENTS
            //------------------------
            //
            // Add layer control elements
            var baseMaps = {
                "OpenStreetMap": OpenStreetMap_DE,
                "CartoDB dark_matter": darkmatter,
                "Stamen terrain": Stamen_Terrain
            };
            var overlayMaps = {
                "Postal areas": postal
                //"Research area": postaldissolve
            };
            
            // Add layer control
            // Obtain better control of layer control by declaring it as variable
            var lCtrl = L.control.layers(baseMaps, overlayMaps);
            lCtrl.addTo(mymap);

            // Add additional header text to layer control
            $('<p id="controlTitle1"><strong tkey="lang_basemap">Basemaps<strong></p>').insertBefore('div.leaflet-control-layers-base');
            $('<p id="controlTitle2"><strong tkey="lang_overlay">Overlay maps<strong></p>').insertBefore('div.leaflet-control-layers-overlays');

            //lCtrl.update() triggers language change in layer control dialog. 
            //translate() does not work without this
            lCtrl.update = function(map){
                $("#controlTitle1").replaceWith(
                        '<p id="controlTitle1"><strong tkey="lang_basemap">Basemaps<strong></p>');
                $("#controlTitle2").replaceWith(
                        '<p id="controlTitle2"><strong tkey="lang_overlay">Overlay maps<strong></p>');
            };

            //Add leaflet-control.geocoder. Prevent queries outside Finland.
            //See links for details. It seems Nominatim does not support city
            //specific queries.
            //https://github.com/perliedman/leaflet-control-geocoder/issues/32
            //https://github.com/perliedman/leaflet-control-geocoder/issues/40
            //http://nominatim.org/release-docs/develop/api/Search/
            var geocoder = L.Control.geocoder({
                geocoder: L.Control.Geocoder.nominatim({
                        geocodingQueryParams: {
                            countrycodes: 'fi'
                        }
                    }),
                defaultMarkGeocode: false,
                placeholder: "Please enter a place or address",
                errorMessage: "Your query produced no results."
                })
                .on('markgeocode', function(e) {
                    var bbox = e.geocode.bbox;
                    var poly = L.polygon([
                         bbox.getSouthEast(),
                         bbox.getNorthEast(),
                         bbox.getNorthWest(),
                         bbox.getSouthWest()
                    ]);
                    mymap.fitBounds(poly.getBounds().pad(0.6));
                })
                .addTo(mymap);


            //-------------------------
            //FORMATION OF SURVEY POPUP
            //-------------------------
            //
            //Listen to changes in popup form
            //Listen to current click on geojson layer named "geojson"
            //this listener idea from: http://embed.plnkr.co/8qVoW5/
            function layerClickHandler (e) {
                                
                //update situation with submit button
                arePopupsFinished();
                
                // catch clicked Polygon
                var pol = e.target,
                        properties = e.target.feature.properties;   
                
                // construct popup zip area code and name and the html element
                currentZip = pol.feature.properties.zipcode;
                currentAreaName = getAreaName(currentZip);
                html = `<div tkey="lang_zipArea">Zip code area:</div> ${currentAreaName}, ${currentZip}`;
                
                if(pol.hasOwnProperty('_popup')){
                    pol.unbindPopup();
                }
                
                //check if all values are inserted and print text in popUp
                //if this is the case
                if(!properties.likert || !properties.parkspot || 
                        !properties.parktime || !properties.walktime ||
                        !properties.timeofday){
                    if (getCookie("popupsize") === "default") {
                        defaultPopup(pol, html + popupContent + missingStuff);
                    } else if(getCookie("popupsize") === "medium") {
                        mediumPopup(pol, html + popupContent + missingStuff);
                    } else if (getCookie("popupsize") === "small") {
                        smallPopup(pol, html + popupContent + missingStuff);
                    }
                } else {
                    if (getCookie("popupsize") === "default") {
                        defaultPopup(pol, html + popupContent);
                    } else if (getCookie("popupsize") === "medium") {
                        mediumPopup(pol, html + popupContent);
                    } else if (getCookie("popupsize") === "small") {
                        smallPopup(pol, html + popupContent);
                    }
                }
                
                //strip layer geojson of click events to prevent user clicking
                //on the layer and producing unwanted survey behaviour.
                disableClicksOnLayer();
                
                //use jQuery to listen to current popup and its close button.
                //This way we can communicate correctly with the function
                //previousGeometrySame().
                $("a.leaflet-popup-close-button").one('click', function(e){
                    console.log("Pressed x in popup dialog");
                    enableClicksOnLayer(); //resume normal behaviour
                    updateGeomColors();
                    arePopupsFinished();
                    testUIstate();
                });

                // keep language up to date with var currentLang. currentLang
                // is updated in beginning of this script file when determining
                // cookie language value and when user presses langbutton
                languageCheckUp();


                //PARKING TIME
                L.DomUtil.get('parktime').textContent = properties.parktime;
                var parkTime = L.DomUtil.get('parktime');
                parkTime.value = properties.parktime;
                L.DomEvent.addListener(parkTime, "change", function (e){
                    //This if statement prevents values larger than 99. It
                    //works in tandem with the input type number html element.
                    if(parkTime.value > 99){
                        properties.parktime = 99;
                    } else {
                        properties.parktime = e.target.value;
                    }
                });
                
                //WALKING TIME
                L.DomUtil.get('walktime').textContent = properties.walktime;
                var walkTime = L.DomUtil.get('walktime');
                walkTime.value = properties.walktime;
                L.DomEvent.addListener(walkTime, "change", function (e){
                    //This if statement prevents values larger than 99. It
                    //works in tandem with the input type number html element.
                    if(walkTime.value > 99){
                        properties.walktime = 99;
                    } else {
                        properties.walktime = e.target.value;
                    }
                });
                
                //LIKERT
                $(L.DomUtil.get('likert')).find(
                        "input[value='" + properties.likert+ "']").attr('checked', true);
                $(document).ready(function(){
                    $('input[name=likert]').click(function(){
                        properties.likert = this.value;
                    });
                });

                //PARKSPOT
                if(typeof currentParkspotValue !== 'undefined'){
                    $(L.DomUtil.get('parkspot')).find(
                            "option[value='" + currentParkspotValue + "']").attr('selected', true);
                    var parkSpot = L.DomUtil.get('parkspot');
                    parkSpot.value = properties.parkspot;
                    L.DomEvent.addListener(parkSpot, "change", function(e){
                        properties.parkspot = e.target.value;
                    });
                } else {
                    L.DomUtil.get('parkspot').value = properties.parkspot;
                    var parkSpot = L.DomUtil.get('parkspot');
                    parkSpot.value = properties.parkspot;
                    L.DomEvent.addListener(parkSpot, "change", function (e){
                        properties.parkspot = e.target.value;
                    });
                }
                
                //TIME OF DAY
                if(typeof currentTimeOfDayValue !== 'undefined'){
                    $(L.DomUtil.get('timeofday')).find(
                            "option[value='" + currentTimeOfDayValue + "']").attr('selected', true);
                    var timeOfDay = L.DomUtil.get('timeofday');
                    timeOfDay.value = properties.timeofday;
                    L.DomEvent.addListener(timeOfDay, "change", function(e){
                        properties.timeofday = e.target.value;
                    });
                } else {
                    L.DomUtil.get('timeofday').value = properties.timeofday;
                    var timeOfDay = L.DomUtil.get('timeofday');
                    timeOfDay.value = properties.timeofday;
                    L.DomEvent.addListener(timeOfDay, "change", function (e){
                        properties.timeofday = e.target.value;
                    });
                }

                //SAVE BUTTON
                //var buttonSubmit = L.DomUtil.get('button-submit');
                //L.DomEvent.addListener(buttonSubmit, "click", function (e){
                $("button#button-submit").on('click', function(e) {
                    e.stopPropagation();
                    e.preventDefault();
                    updateGeomColors();
                    enableClicksOnLayer();
                    pol.closePopup();
                    arePopupsFinished();
                    testUIstate();
                });
                
                //DELETE BUTTON
                //var buttonDelete = L.DomUtil.get('button-delete');
                //L.DomEvent.addListener(buttonDelete, "click", function (e){
                $("button#button-delete").on('click', function(e) {
                    e.stopPropagation();
                    e.preventDefault();
                    //Using class TrackZipCodes we are able to keep track of
                    //zip codes user has clicked on. They can also be removed,
                    //which is important for the functionality of this survey.
                    usersZipCodes.removeZipCode(window.currentZip);
                    enableClicksOnLayer();
                    geojson.removeLayer(pol);
                    arePopupsFinished();
                    testUIstate();
                });
                
                // Make sure that placeholder option is seen if no value is
                // detected in select element "parkspot" or "timeofday". Does
                // this fix Apple problems?
                // this would have been easiest to do in pure html, but the
                // listeners in this function required select tags to have
                // ids. These ids in turn made the placeholders not appear
                // at all on Chrome and would lead Safari to show the first
                // select option as default, leading to problems.
                if(properties.parkspot === null) {
                    document.getElementById('parkspot').selectedIndex = 0;
                }
                if (properties.timeofday === null) {
                    document.getElementById('timeofday').selectedIndex = 0;
                }
            }
    
    
    
            //------------------------------
            //LANGUAGE BUTTON AND INFOBUTTON
            //------------------------------
            //
            //LANGUAGE BUTTON
            var langButton = L.easyButton({
                states: [{
                    stateName: 'fi',
                    icon: '<b class="langbuttontext">FI</b>',
                    title: "Change language to English",
                    onClick: function (btn, map){
                        console.log("Current language English. Cookie updated.");
                        $.getJSON('en.json', translate);
                        window.currentLang = "en"; // inform layerClickHandler()
                        // layer control button translation needs updating
                        lCtrl.update();
                        btn.state('en');

                        // update cookie value each time langbutton is pressed
                        create_cookie("lang", "en", 90, "/");
                    }
                }, {
                    stateName: 'en',
                    icon: '<b class="langbuttontext">EN</b>',
                    title: "Vaihda kieli suomeksi",
                    onClick: function (btn, map){
                        console.log("Current language Finnish. Cookie updated.");
                        $.getJSON('fi.json', translate);
                        window.currentLang = "fi"; // inform layerClickHandler()
                        lCtrl.update();
                        btn.state('fi');
                        create_cookie("lang", "fi", 90, "/");
                        
                    }
                }]
            });
            langButton.addTo(mymap);
 
            //INFOBUTTON
            var infoButton = L.easyButton({
                type: 'animate',
                states: [{
                    stateName: 'infoOpen',
                    icon: 'fa fa-info',
                    title: 'Open info',
                    onClick: function (btn, map) {
                        //initialise jQuery UI dialog and tabs through this
                        //function
                        $(initialiseInfo);
                        btn.state('infoClose');
                        
                        // Listen to x button in jQuery dialog to keep infobutton
                        // up to date
                        $(".ui-dialog-titlebar-close").one('click', function(e) {
                            btn.state('infoOpen');
                        });
                    }
                }, {
                    stateName: 'infoClose',
                    icon: 'fa fa-info',
                    title: 'Close info',
                    onClick: function (btn, map) {
                        $("#tabsikkuna").dialog("close");
                        btn.state('infoOpen');
                    }
                }]
            });
            infoButton.addTo(mymap);
            
            
            
            //---------------------
            //SUBMIT RECORDS BUTTON
            //---------------------
            //
            // SENDBOX AND BUTTON
            var sendBox = L.control({position: 'bottomright'});
            sendBox.onAdd = function (map) {
                this._div = L.DomUtil.create('div', 'sendbox');
                this.update();
                return this._div;
            };
            sendBox.update = function () {
                this._div.innerHTML = normalSubmit; //type of button

                // Button text would default to the one in HTML code without
                // the following if statement
                languageCheckUp();
                
                // enable or re-enable submit button listener. Ready function
                // is needed in the initial loading of the survey.
                $(document).ready(function(){
                    submitButtonListener();
                });
            };
            // "disable send button" function
            sendBox.disable = function () {
                this._div.innerHTML = disabledSubmit;
                languageCheckUp();
            };
            sendBox.addTo(mymap);

            //prevent unwanted map clicks and other events on sendBox
            L.DomEvent.on(buttonsubmitall, 'click', function(e){
                L.DomEvent.stopPropagation(e);
            });
            L.DomEvent.on(buttonsubmitall, 'dblclick', function(e){
                L.DomEvent.stopPropagation(e);
            });
            sendBox.getContainer().addEventListener('mouseover', function(){
                mymap.dragging.disable();
                mymap.scrollWheelZoom.disable();
            });
            sendBox.getContainer().addEventListener('mouseout', function(){
                mymap.dragging.enable();
                mymap.scrollWheelZoom.enable();
            });
            
            
            // Implement a div that appears above Submit records button when
            // the user has unfinished zip code areas active on the map
            var unfinishedBox = L.control({position: 'bottomright'});
            unfinishedBox.onAdd = function (map) {
                this._div = L.DomUtil.create('div', 'unfinished');
                this.update();
                return this._div;
            };
            
            //unfinishedBox updates through checking if the function
            //usersZipCodes.queryIncompleteness() returns empty or not
            unfinishedBox.update = function () {
                
                //UIState checks if hideUI() has been triggered
                if(UIState === true) {
                    if(usersZipCodes.queryIncompleteness() === "<p></p>") {
                        $("div.unfinished").fadeOut("fast");
                    } else {
                        $("div.unfinished").fadeIn("fast");
                        
                        // Contents of the div
                        this._div.innerHTML = 
                                "<div class='transbox'><p>" + 
                                "<i class='icon comment'></i>" +
                                "<b class='redtext'>You have unfinished areas</b>" + 
                                usersZipCodes.queryIncompleteness() + 
                                "</p></div>";
                    }
                }
            };
            unfinishedBox.addTo(mymap);
        </script>
        
        <!--JQUERY UI DIALOG CONTENT-->
        <div id="sucdialog" title="Submit success!" style="display:none">
            <div class="sucimage"></div>​
            <div id="response"></div>
            <p tkey="lang_thanks">Thank you for taking the time to respond to this survey!</p>
        </div>
        
        <div id="tabsikkuna" style="overflow: scroll" title="Parking private cars in Helsinki Capital Region">
            <div id="tabs" class="tabscontainer">
                <ul>
                    <li><a href="#tabs-1" tkey="lang_tab1">Tervetuloa kyselyyn!</a></li>
                    <li><a href="#tabs-2" tkey="lang_tab2">Tutkimuksesta</a></li>
                    <li><a href="#tabs-3" tkey="lang_tab3">Käyttöohjeet</a></li>
                    <li><a href="#tabs-4"><i class='icon wrench'></i></a></li>
                </ul>
                <div id="tabs-1" class="tabspanel">
                    <p id="version" tkey="lang_version"></p>
                    <p id="mobilewarning"></p>
                    <p id="yourlang"><span tkey="lang_lang">Hei! Valitse kielesi:</span>
                        <img class="lang_img" id="button-en" src="images/gb.png" alt="Switch to English">
                        <img class="lang_img" id="button-fi" src="images/fi.png" alt="Vaihda suomen kieleen">
                    </p>
                    <H2 tkey="lang_welcome1">Tervetuloa kyselyyn!</H2>
                    <p tkey="lang_welcome2">Tämän kyselyn tarkoituksena on selvittää kuinka kauan henkilöauton pysäköinti kestää pääkaupunkiseudulla. Kyselyssä huomioidaan pysäköinnin koko prosessi: kuinka kauan pysäköintipaikkaa etsittiin, minne auto pysäköitiin ja missä oli vastaajan todellinen määränpää. Kyselyssä kerättyjä tietoja käytetään Helsingin yliopiston geoinformatiikan pro gradu -tutkimuksessa, josta voit lukea lisää allaolevasta "tarkempaa tietoa kyselystä" -kohdassa.</p>
                    <p tkey="lang_welcome3">Tämä kysely tähtää vaivattomuuteen: Jos et muista pysäköinnin tarkkaa aikaa tai paikkaa, voit syöttää näistä arvion. Voit täyttää kyselyn vaikka jokaisen pääkaupunkiseudulla tapahtuneen henkilöautomatkasi päätteeksi, tai täyttää lomakkeen yhdeltä istumalta monta kertaa.</p>
                    <p tkey="lang_welcome4">Pyydän mahdollisuuksien mukaan jatkamaan kyselyyn vastaamista 31.3.2019 asti.</p>
                    <p tkey="lang_welcome5"><b>Huom!</b> Huomaathan, että <i>kyselyssä ei kartoiteta kotipihapysäköintiä tai sellaista pysäköintiä, jossa vastaajalla on käytössä henkilökohtainen pysäköintipaikka</i>.</p>
                    <p tkey="lang_welcome6">Kiitän vastauksestasi, <br>terveisin, Sampo Vesanen</p>
                    <p tkey="lang_welcome7">Kyselyyn liittyvissä asioissa ota minuun yhteyttä sähköpostitse: sampo.vesanen(at)helsinki.fi</p>
                    <button id="button-accesssurvey" class="icon play" type="button" tkey="lang_accesssurvey"></button>
                </div>
                <div id="tabs-2" class="tabspanel">
                    <H2 tkey="lang_aboutH2">More on the subject</H2>
                    <p tkey="lang_about1">Tämän kyselyn tarkoituksena on tutkia pysäköintiin kuluvan ajan alueellista vaihtelua pääkaupunkiseudulla. Kysely noudattaa Salosen ja Toivosen (2013) matka-aikojen mittaamiseen tarkoitettua ovelta ovelle -menetelmää, jonka osana pysäköimisprosessi on. Menetelmän mukaisesti tässä kyselyssä kysytään <b>1)</b> kuinka kauan pysäköintipaikan löytymiseen kului aikaa pysäköinnin etsimisen aloittamisesta, <b>2)</b> missä pysäköintipaikka sijaitsi sekä <b>3)</b> missä oli matkan lopullinen määränpää. Kyselyn tulokset ovat perustana geoinformatiikka-aiheiselle pro gradu -tutkielmalleni, jonka työnimi on <i>Parking of private cars and spatial accessibility in Greater Helsinki Area</i>. Tuloksia käytetään parantamaan Helsingin yliopistossa toimivan Accessibility Research Groupin kehittämää Helsingin seudun matka-aikamatriisimallia (Toivonen et al. 2015). Tällä hetkellä ryhmä käyttää matka-aikamatriisissa karkeaa arviota pysäköintiin kuluvasta ajasta (Kalenoja & Häyrynen 2003). Pro gradu -tutkielmani hypoteesina on, että pysäköintiprosessin kesto vaihtelee pääkaupunkiseudun eri osissa, ja tästä tutkimuksesta saatavat tulokset mahdollistavat alueellisen vaihtelun tutkimisen ja visualisoinnin. Pääset tutustumaan Digital Geography Labin tutkimukseen <a target="_blank" rel="noopener noreferrer" href="https://www.helsinki.fi/en/researchgroups/digital-geography-lab">täällä</a> (avautuu uuteen ikkunaan).</p>
                    <div>
                        <img style="max-width: 100%; height: auto; width: auto;" src="images/door2door.png" alt="Door to door -approach"></img>
                        <div class="caption" tkey="lang_door2door"></div>
                    </div>
                    <p tkey="lang_about2"></p>
                    <p tkey="lang_about3"><b>Henkilötietosuojasta:</b> Tässä kyselyssä sinulta kysytään pysäköintisi ja määränpääsi sijaintia. Tämä on mahdollisesti arkaluontoista tietoa, ja vakuutan, että vastauksista ei voi tunnistaa yksilöitä. Kyselyvastausten analysointivaiheessa vastaajien ilmoittamat geopisteet asetetaan YKR-aluejaon (Suomen ympäristökeskus 2018) mukaiseen ruudukkoon (250 metriä kertaa 250 metriä), joka poistaa lopullisesta, pro gradussa esitellystä aineistosta, tarkat sijaintitiedot. Tutkimuksessa ei olla kiinnostuneita 250x250 metriä tarkemmista sijainneista. Pääset tarkastelemaan tutkimusaluetta ja tutkimusruudukon tarkkuutta <a target="_blank" rel="noopener noreferrer" href="http://www.helsinki.fi/science/accessibility/tools/YKR/YKR_Identifier.html">tästä</a> (avautuu uuteen ikkunaan).</p>
                    <p tkey="lang_about4"></p>
                    <H3 tkey="lang_about5">Kirjallisuus</H3>
                    <ul type="1" style="list-style-position:inside;">
                        <li tkey="lang_about6">Kalenoja, H. & J.-P. Häyrynen (2003). Keskustan pysäköinti osana liikennejärjestelmää – Tampereen keskustan pysäköintitutkimus. Tutkimusraportti 51. Tampere University of Technology, Tampere.</li>
                        <li tkey="lang_about7">Salonen, M. & T. Toivonen (2013). Modelling travel time in urban networks: Comparable measures for private car and public transport. <i>Journal of Transport Geography</i> 31: 143–153.</li>
                        <li tkey="lang_about8">Toivonen, T., H. Tenkanen, V. Heikinheimo, T. Jaakkola, J. Järvi & M. Salonen (2015). Helsinki Region-Travel Time Matrix 2015. DOI: 10.13140/RG.2.1.1901.3201</li>
                        <li tkey="lang_about9">Toivonen, T., M. Salonen, H. Tenkanen, P. Saarsalmi, T. Jaakkola & J. Järvi (2014). Joukkoliikenteellä, autolla ja kävellen: Avoin saavutettavuusaineisto pääkaupunkiseudulla. <i>Terra</i> 126: 3, 127–136.</li>
                        <li tkey="lang_about10">YKR-aluejaot (2018). Suomen ympäristökeskus.</li>
                    </ul>
                </div>
                <div id="tabs-3" class="tabspanel">
                    <H2 tkey="lang_instr1">Lomakkeen täyttöohje</H2>
                    <H3 tkey="lang_instr2">Kyselyn käyttöliittymä</H3>
                    <H4 tkey="lang_instr3">Ruudun vasen yläkulma</H4>
                    <img style="float: left; padding: 0 20px 20px 0;" src="images/zoom.png" alt="Zoom button"><p tkey="lang_instr4"></p></img>
                    <img style="float: left; padding: 0 20px 20px 0;" src="images/lang.png" alt="Language button"><p tkey="lang_instr5"></p></img>
                    <img style="float: left; padding: 0 20px 20px 0;" src="images/info.png" alt="Information button"><p tkey="lang_instr6"></p></img>
                    <H4 tkey="lang_instr7">Ruudun oikea yläkulma</H4>
                    <img style="float: left; padding: 0 20px 20px 0;" src="images/layers.png" alt="Layer control button"><p tkey="lang_instr8"></p></img>
                    <img style="float: left; padding: 0 20px 20px 0;" src="images/geocoder.png" alt="Search area button"><p tkey="lang_instr9"></p></img>
                    <H4 tkey="lang_instr10">Ruudun oikea alakulma</H4>
                    <p tkey="lang_instr11"></p>
                    <p tkey="lang_instr12"></p>
                    <H3 tkey="lang_survey1"></H3>
                    <img id="survey_screen" style="float: left; padding: 0 20px 20px 0;" src="images/survey_fi.png" alt="Survey popup">
                        <p tkey="lang_survey2"></p>
                        <p tkey="lang_survey3"></p>
                        <p tkey="lang_survey4"></p>
                        <p tkey="lang_survey5"></p>
                        <p tkey="lang_survey6"></p>
                        <p tkey="lang_survey7"></p>
                        <p tkey="lang_survey8"></p>
                        <p tkey="lang_survey9"></p>
                    </img>
                    <H3 tkey="lang_tech1">Tekniset yksityiskohdat</H3>
                    <ul>
                        <li tkey="lang_tech2">Jos törmäät ongelmiin täyttäessäsi lomaketta, tarkista verkkoselaimesi ajantasaisuus</li>
                        <li tkey="lang_tech3">Lomake on koekäytetty seuraavilla selaimilla. Suosittelen käyttämään jotain seuraavista:</li>
                        <ul>
                            <li tkey="lang_tech4">Älypuhelimella: Chrome (ainakin versio 71)</li>
                            <li tkey="lang_tech5"></li>
                            <li tkey="lang_tech6">Pöytätietokoneella/kannettavalla: Chrome (ainakin versio 71), Firefox (versio 64), Edge (versio 42)</li>
                        </ul>
                        <br>
                        <li tkey="lang_tech7">Jos käytät älypuhelinta lomakkeen täyttämiseen ja ongelmasi eivät hälvene vaikka olet seurannut ylläolevia ohjeita, kokeile täyttää lomake pöytä- tai kannettavalla tietokoneella (vaihtoehtoisesti voit kokeilla puhelinta, jos tietokoneella lomake tuottaa ongelmia). Testieni mukaan tietokoneversio tästä lomakkeesta on käyttövarmempi kuin älypuhelimen.</li>
                    </ul>
                </div>
                <div id="tabs-4" class="tabspanel">
                    <H2 tkey="lang_settings1">Settings</H2>
                    <div style="background: 15px #e8e8e8; padding: 10px;margin: 20px;border-radius: 5px;box-shadow: 5px 5px 8px rgba(0, 0, 0, 0.2);">
                        <p tkey="lang_settings2">fdfd</p>
                        <button id="button-closeinfo" class="icon window-close" type="button" tkey="lang_buttoncloseinfo">Stop showing this dialog box at startup</button>
                    </div>
                    <div style="background: 15px #e8e8e8; padding: 10px;margin: 20px;border-radius: 5px;box-shadow: 5px 5px 8px rgba(0, 0, 0, 0.2);">
                        <p tkey="lang_settings3">fdfdfdfd</p>
                        <button id="button-changepopupsize" class="icon expand-arrows-alt" type="button"><div class="popupsize" tkey="lang_changepopupsize">Popup size: </div></button>
                    </div>
                    <div style="background: 15px #e8e8e8; padding: 10px;margin: 20px;border-radius: 5px;box-shadow: 5px 5px 8px rgba(0, 0, 0, 0.2);">
                        <p tkey="lang_settings4">fdfdfdfd</p>
                        <button id="button-changedevice" class="icon mobile-alt" type="button" tkey="lang_buttonchangedevice">Change device settings. WARNING! Refreshes page, all non-submitted records will be lost!</button>
                    </div>
                </div>
            </div>
        </div>
        
    </body>
</html>